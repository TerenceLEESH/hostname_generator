{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESXi Hostname Generator</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 0;
        }
        
        .step {
            position: relative;
            z-index: 1;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .step.active {
            background: #007bff;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        .question-container {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ESXi Hostname Generator</h1>
        
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        <!-- Step indicators -->
        <div class="step-indicator">
            {% for step in steps_to_display %}
                {% if step < current_step %}
                    <div class="step completed">âœ“</div>
                {% elif step == current_step %}
                    <div class="step active">{{ step }}</div>
                {% else %}
                    <div class="step">{{ step }}</div>
                {% endif %}
            {% endfor %}
        </div>
        
        <form method="post" id="hostname-form">
            {% csrf_token %}
            
            <div class="question-container">
                {% if current_step == 1 %}
                    <!-- Q1: Is it under an existing cluster? -->
                    <h4>Question 1: Cluster Information</h4>
                    <div class="form-group">
                        <label>Is it under an existing cluster?</label>
                        <div class="form-check">
                            <input type="radio" name="existing_cluster" value="True" id="id_existing_cluster_yes" class="form-check-input" required 
                                   {% if prev_data.1.existing_cluster == "True" %}checked{% endif %}>
                            <label class="form-check-label" for="id_existing_cluster_yes">Yes</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="existing_cluster" value="False" id="id_existing_cluster_no" class="form-check-input"
                                   {% if prev_data.1.existing_cluster == "False" %}checked{% endif %}>
                            <label class="form-check-label" for="id_existing_cluster_no">No</label>
                        </div>
                    </div>
                
                {% elif current_step == 2 %}
                    <!-- Q2: OSA or ESA? (Only if Q1 was No) -->
                    <h4>Question 2: Service Architecture</h4>
                    {% if prev_data.1.existing_cluster == "False" %}
                        <div class="form-group">
                            <label for="id_service_architecture">OSA or ESA?</label>
                            <select name="service_architecture" id="id_service_architecture" class="form-control" required>
                                <option value="">Select architecture</option>
                                <option value="OSA" {% if prev_data.2.service_architecture == "OSA" %}selected{% endif %}>OSA</option>
                                <option value="ESA" {% if prev_data.2.service_architecture == "ESA" %}selected{% endif %}>ESA</option>
                            </select>
                        </div>
                    {% else %}
                        <p>Since this is under an existing cluster, we'll skip architecture and zone questions.</p>
                        <input type="hidden" name="service_architecture" value="">
                    {% endif %}
                
                {% elif current_step == 3 %}
                    <!-- Q3: Which zone? (Only if Q1 was No) -->
                    <h4>Question 3: Zone</h4>
                    {% if prev_data.1.existing_cluster == "False" %}
                        <div class="form-group">
                            <label for="id_zone">Which zone it belongs to?</label>
                            <select name="zone" id="id_zone" class="form-control" required>
                                <option value="">Select zone</option>
                                <option value="A" {% if prev_data.3.zone == "A" %}selected{% endif %}>A</option>
                                <option value="B" {% if prev_data.3.zone == "B" %}selected{% endif %}>B</option>
                                <option value="C" {% if prev_data.3.zone == "C" %}selected{% endif %}>C</option>
                                <option value="D" {% if prev_data.3.zone == "D" %}selected{% endif %}>D</option>
                                <option value="E" {% if prev_data.3.zone == "E" %}selected{% endif %}>E</option>
                            </select>
                        </div>
                    {% else %}
                        <p>Since this is under an existing cluster, we'll skip architecture and zone questions.</p>
                        <input type="hidden" name="zone" value="">
                    {% endif %}
                
                {% elif current_step == 4 %}
                    <!-- Q4: How many ESXi hostnames? -->
                    <h4>Question 4: Hostname Count</h4>
                    <div class="form-group">
                        <label for="id_hostname_count">How many ESXi hostnames do you need?</label>
                        <input type="number" name="hostname_count" id="id_hostname_count" class="form-control" min="1" max="100" required
                               value="{{ prev_data.4.hostname_count|default:'1' }}">
                    </div>
                
                {% elif current_step == 5 %}
                    <!-- Q5: Select the datacenter -->
                    <h4>Question 5: Datacenter</h4>
                    <div class="form-group">
                        <label for="id_datacenter">Select the datacenter:</label>
                        <select name="datacenter" id="id_datacenter" class="form-control" required>
                            <option value="">Select datacenter</option>
                            {% for dc in datacenters %}
                                <option value="{{ dc.datacenter }}" 
                                        data-sitecode="{{ dc.sitecode }}" 
                                        {% if prev_data.5.datacenter == dc.datacenter %}selected{% endif %}>
                                    {{ dc.datacenter }} ({{ dc.sitecode }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                
                {% elif current_step == 6 %}
                    <!-- Q6: Is this host in DMZ? -->
                    <h4>Question 6: DMZ Status</h4>
                    <div class="form-group">
                        <label>Is this host in DMZ?</label>
                        <div class="form-check">
                            <input type="radio" name="is_dmz" value="True" id="id_is_dmz_yes" class="form-check-input" required 
                                   {% if prev_data.6.is_dmz == "True" %}checked{% endif %}>
                            <label class="form-check-label" for="id_is_dmz_yes">Yes</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="is_dmz" value="False" id="id_is_dmz_no" class="form-check-input"
                                   {% if prev_data.6.is_dmz == "False" %}checked{% endif %}>
                            <label class="form-check-label" for="id_is_dmz_no">No</label>
                        </div>
                    </div>
                
                {% elif current_step == 7 %}
                    <!-- Q7: Hardware type -->
                    <h4>Question 7: Hardware Type</h4>
                    {% if prev_data.6.is_dmz == "False" %}
                        <div class="form-group">
                            <label for="id_hardware_type">Hardware type:</label>
                            <select name="hardware_type" id="id_hardware_type" class="form-control" required>
                                <option value="">Select hardware type</option>
                                <option value="Dell" {% if prev_data.7.hardware_type == "Dell" %}selected{% endif %}>Dell</option>
                                <option value="HP" {% if prev_data.7.hardware_type == "HP" %}selected{% endif %}>HP</option>
                            </select>
                        </div>
                    {% else %}
                        <p>For DMZ hosts, special configuration will be applied.</p>
                        <input type="hidden" name="hardware_type" value="DMZ">
                    {% endif %}
                
                {% elif current_step == 8 %}
                    <!-- Q8: Select cloud code -->
                    <h4>Question 8: Cloud Code</h4>
                    <div class="form-group">
                        <label for="id_cloud_code">Select the cloud code:</label>
                        <select name="cloud_code" id="id_cloud_code" class="form-control" required>
                            <option value="">Select cloud code</option>
                            <option value="QQA" {% if prev_data.8.cloud_code == "QQA" %}selected{% endif %}>QQA</option>
                            <option value="QQB" {% if prev_data.8.cloud_code == "QQB" %}selected{% endif %}>QQB</option>
                            <option value="QQC" {% if prev_data.8.cloud_code == "QQC" %}selected{% endif %}>QQC</option>
                            <option value="custom" {% if prev_data.8.cloud_code != "QQA" and prev_data.8.cloud_code != "QQB" and prev_data.8.cloud_code != "QQC" and prev_data.8.cloud_code %}selected{% endif %}>Custom (specify)</option>
                        </select>
                    </div>
                    
                    <!-- Custom cloud code input field (shown/hidden with JS) -->
                    <div class="form-group" id="custom_cloud_code_group" style="display: none;">
                        <label for="id_custom_cloud_code">Enter custom cloud code:</label>
                        <input type="text" name="custom_cloud_code" id="id_custom_cloud_code" 
                               class="form-control" maxlength="10" 
                               value="{% if prev_data.8.cloud_code != 'QQA' and prev_data.8.cloud_code != 'QQB' and prev_data.8.cloud_code != 'QQC' %}{{ prev_data.8.cloud_code }}{% endif %}">
                        <small class="form-text text-muted">Please enter a custom cloud code (max 10 characters)</small>
                    </div>
                
                {% elif current_step == 9 %}
                    <!-- Q9: Select zone type -->
                    <h4>Question 9: Zone Type</h4>
                    <div class="form-group">
                        <label for="id_zone_type">Select the zone type:</label>
                        <select name="zone_type" id="id_zone_type" class="form-control" required>
                            <option value="">Select zone type</option>
                            <option value="AAA" {% if prev_data.9.zone_type == "AAA" %}selected{% endif %}>AAA</option>
                            <option value="BBB" {% if prev_data.9.zone_type == "BBB" %}selected{% endif %}>BBB</option>
                            <option value="CCC" {% if prev_data.9.zone_type == "CCC" %}selected{% endif %}>CCC</option>
                        </select>
                    </div>

                    <!-- Preview section for the final step -->
                    <div class="mt-4">
                        <h5>Preview:</h5>
                        {% if prev_data.1.existing_cluster == "False" %}
                            <div class="mb-3">
                                <label>Cluster Name:</label>
                                <div class="alert alert-primary" id="cluster-preview">
                                    Cluster name will be generated
                                </div>
                                <div id="cluster-exists-warning" class="text-danger" style="display: none;">
                                    <small>Warning: This cluster name already exists. A new sequence number will be used.</small>
                                </div>
                            </div>
                        {% endif %}
                        <div>
                            <label>ESXi Hostname:</label>
                            <div class="alert alert-info" id="hostname-preview">
                                Hostname will be generated based on your selections
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Show summary of previous answers -->
                {% if current_step > 1 %}
                    <div class="previous-answers mt-4">
                        <h5>Your previous answers:</h5>
                        <ul class="list-group">
                            {% if current_step > 1 and prev_data.1 %}
                                <li class="list-group-item">
                                    <strong>Existing cluster:</strong> 
                                    {% if prev_data.1.existing_cluster == "True" %}Yes{% else %}No{% endif %}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 2 and prev_data.2 and prev_data.1.existing_cluster == "False" %}
                                <li class="list-group-item">
                                    <strong>Service architecture:</strong> {{ prev_data.2.service_architecture }}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 3 and prev_data.3 and prev_data.1.existing_cluster == "False" %}
                                <li class="list-group-item">
                                    <strong>Zone:</strong> {{ prev_data.3.zone }}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 4 and prev_data.4 %}
                                <li class="list-group-item">
                                    <strong>Hostname count:</strong> {{ prev_data.4.hostname_count }}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 5 and prev_data.5 %}
                                <li class="list-group-item">
                                    <strong>Datacenter:</strong> {{ prev_data.5.datacenter }}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 6 and prev_data.6 %}
                                <li class="list-group-item">
                                    <strong>DMZ host:</strong> 
                                    {% if prev_data.6.is_dmz == "True" %}Yes{% else %}No{% endif %}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 7 and prev_data.7 and prev_data.6.is_dmz == "False" %}
                                <li class="list-group-item">
                                    <strong>Hardware type:</strong> {{ prev_data.7.hardware_type }}
                                </li>
                            {% endif %}
                            
                            {% if current_step > 8 and prev_data.8 %}
                                <li class="list-group-item">
                                    <strong>Cloud code:</strong> {{ prev_data.8.cloud_code }}
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                {% endif %}
            </div>
            
            <div class="nav-buttons">
                {% if current_step > 1 %}
                    <button type="submit" name="prev_step" class="btn btn-secondary">Previous</button>
                {% else %}
                    <div></div> <!-- Empty div for spacing -->
                {% endif %}
                
                {% if current_step < 9 %}
                    {% if current_step == 6 and prev_data.6.is_dmz == "True" %}
                        <button type="submit" name="submit" class="btn btn-success">Generate Hostname</button>
                    {% else %}
                        <button type="submit" name="next_step" class="btn btn-primary">Next</button>
                    {% endif %}
                {% else %}
                    <button type="submit" name="submit" class="btn btn-success">Generate Hostname</button>
                {% endif %}
            </div>
        </form>
        
        {% if generated_hostnames %}
        <div class="mt-5">
            <h3>Generated Hostnames</h3>
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Results</span>
                    <button id="copy-results" class="btn btn-sm btn-outline-primary">Copy All</button>
                </div>
                <div class="card-body">
                    {% if cluster_name %}
                    <div class="mb-3">
                        <strong>Cluster Name:</strong> 
                        <span id="cluster-result">{{ cluster_name }}</span>
                    </div>
                    {% endif %}
                    <strong>Hostnames:</strong>
                    <ol id="hostname-results">
                        {% for hostname in generated_hostnames %}
                        <li>{{ hostname }}</li>
                        {% endfor %}
                    </ol>
                </div>
            </div>
            <a href="{% url 'esxi_hostname' %}" class="btn btn-warning mt-3">Start Over</a>
        </div>
        {% endif %}
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            // Skip to Q4 if cluster = Yes on step 1
            {% if current_step == 1 %}
                $('input[name="existing_cluster"]').change(function() {
                    if ($(this).val() === 'True') {
                        $('#hostname-form').append('<div class="alert alert-info mt-3" id="step-skip-info">You will skip directly to hostname count question.</div>');
                    } else {
                        $('#step-skip-info').remove();
                    }
                });
                
                // Initialize on page load
                if ($('#id_existing_cluster_yes').is(':checked')) {
                    $('#id_existing_cluster_yes').trigger('change');
                }
            {% endif %}
            
            // Generate button on Q6 if DMZ = Yes
            {% if current_step == 6 %}
                $('input[name="is_dmz"]').change(function() {
                    if ($(this).val() === 'True') {
                        $('.nav-buttons').html('<div></div><button type="submit" name="submit" class="btn btn-success">Generate Hostname</button>');
                        $('#hostname-form').append('<div class="alert alert-info mt-3" id="dmz-info">DMZ hosts will have special configuration applied. You can generate hostnames now.</div>');
                    } else {
                        $('.nav-buttons').html('<button type="submit" name="prev_step" class="btn btn-secondary">Previous</button><button type="submit" name="next_step" class="btn btn-primary">Next</button>');
                        $('#dmz-info').remove();
                    }
                });
                
                // Initialize on page load
                if ($('#id_is_dmz_yes').is(':checked')) {
                    $('#id_is_dmz_yes').trigger('change');
                } else if ($('#id_is_dmz_no').is(':checked')) {
                    $('#id_is_dmz_no').trigger('change');
                }
            {% endif %}
            
            // Update preview on final step
            {% if current_step == 9 %}
                function updatePreview() {
                    var zoneType = $('#id_zone_type').val() || '[Zone Type]';
                    var cloudCode;
                    if ("{{ prev_data.8.cloud_code }}" === "custom") {
                        cloudCode = "{{ prev_data.8.custom_cloud_code }}";
                    } else {
                        cloudCode = "{{ prev_data.8.cloud_code|default:'QQ' }}";
                    }
                    var datacenter = "{{ prev_data.5.datacenter|default:'DC' }}";
                    var isDmz = "{{ prev_data.6.is_dmz|default:'False' }}";
                    var hardwareType = "{{ prev_data.7.hardware_type|default:'HW' }}";
                    var existingCluster = "{{ prev_data.1.existing_cluster|default:'False' }}";
                    var architecture = "{{ prev_data.2.service_architecture|default:'' }}";
                    var zone = "{{ prev_data.3.zone|default:'' }}";
                    
                    // Get the sitecode from datacenters
                    var sitecode = "";
                    {% for dc in datacenters %}
                        if ("{{ dc.datacenter }}" === datacenter) {
                            sitecode = "{{ dc.sitecode }}";
                        }
                    {% endfor %}
                    if (!sitecode) sitecode = "[Site]";
                    
                    // ESXi Hostname preview
                    var preview;
                    if (isDmz === "True") {
                        // DMZ format: v{sitecode}u111swea with 3-digit number
                        preview = 'v' + sitecode.toLowerCase() + 'u111swea001';  // Starting with 001
                    } else {
                        // Non-DMZ format: l-v{sitecode}{hardwaretype}{cloudcode}{zonetype}{4 digits}
                        var hwCode = hardwareType === "Dell" ? "d" : (hardwareType === "HP" ? "h" : "x");
                        var cloudCodeShort = cloudCode.toLowerCase().substring(0, 3);
                        var zoneTypeShort = zoneType.toLowerCase().substring(0, 3);
                        
                        preview = 'l-v' + sitecode.toLowerCase() + hwCode + cloudCodeShort + zoneTypeShort + '0001';
                    }
                    
                    $('#hostname-preview').text(preview);
                    
                    // Cluster name preview (if creating a new cluster)
                    if (existingCluster === "False") {
                        var clusterPrefix = datacenter + '-APAC-' + architecture + '-' + zone + '-';
                        
                        // Check existing clusternames via AJAX
                        checkExistingClusternames(clusterPrefix, function(nextSequence, exists) {
                            var clusterPreview = clusterPrefix + nextSequence;
                            $('#cluster-preview').text(clusterPreview);
                            
                            // Show warning if we're not using sequence 1
                            if (nextSequence > 1) {
                                $('#cluster-exists-warning').show();
                            } else {
                                $('#cluster-exists-warning').hide();
                            }
                        });
                    }

                    // Check for existing hostnames via AJAX
                    checkExistingHostnames();
                }
                
                // Function to check existing hostnames and update preview accordingly
                function checkExistingHostnames() {
                    var zoneType = $('#id_zone_type').val();
                    var datacenter = "{{ prev_data.5.datacenter|default:'' }}";
                    var isDmz = "{{ prev_data.6.is_dmz|default:'False' }}";
                    var hardwareType = "{{ prev_data.7.hardware_type|default:'' }}";
                    var cloudCode = "{{ prev_data.8.cloud_code|default:'' }}";
                    
                    if (cloudCode === "custom") {
                        cloudCode = "{{ prev_data.8.custom_cloud_code }}";
                    }
                    
                    if (!zoneType || !datacenter || !hardwareType || !cloudCode) {
                        return; // Exit if missing required data
                    }
                    
                    // Create base hostname without number
                    var baseHostname = '';
                    var sitecode = '';
                    
                    {% for dc in datacenters %}
                        if ("{{ dc.datacenter }}" === datacenter) {
                            sitecode = "{{ dc.sitecode }}";
                        }
                    {% endfor %}
                    
                    if (isDmz === "True") {
                        baseHostname = 'v' + sitecode.toLowerCase() + 'u111swea';
                    } else {
                        var hwCode = hardwareType === "Dell" ? "d" : (hardwareType === "HP" ? "h" : "x");
                        var cloudCodeShort = cloudCode.toLowerCase().substring(0, 3);
                        var zoneTypeShort = zoneType.toLowerCase().substring(0, 3);
                        baseHostname = 'l-v' + sitecode.toLowerCase() + hwCode + cloudCodeShort + zoneTypeShort;
                    }
                    
                    // Send AJAX request to check for existing hostnames
                    $.ajax({
                        url: "{% url 'check_existing_hostnames' %}", // You'll need to create this URL
                        type: "POST",
                        data: {
                            'base_hostname': baseHostname,
                            'is_dmz': isDmz,
                            'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(data) {
                            if (data.success) {
                                var nextSequence = data.next_sequence;
                                var hostCount = parseInt("{{ prev_data.4.hostname_count|default:'1' }}");
                                
                                // Show preview with next available sequence
                                if (isDmz === "True") {
                                    var sequenceFormat = String(nextSequence).padStart(3, '0');
                                    $('#hostname-preview').text(baseHostname + sequenceFormat);
                                } else {
                                    var sequenceFormat = String(nextSequence).padStart(4, '0');
                                    $('#hostname-preview').text(baseHostname + sequenceFormat);
                                }
                                
                                // Show a note about the sequence
                                if (nextSequence > 1) {
                                    if ($('#sequence-note').length === 0) {
                                        $('#hostname-preview').after('<div id="sequence-note" class="text-info mt-2"><small>Note: Previous hostnames exist in this sequence. This will be the next available number.</small></div>');
                                    }
                                } else {
                                    $('#sequence-note').remove();
                                }
                                
                                // If multiple hostnames requested, show a note
                                if (hostCount > 1) {
                                    if ($('#multiple-hostnames-note').length === 0) {
                                        $('#hostname-preview').after('<div id="multiple-hostnames-note" class="text-info mt-2"><small>Note: ' + hostCount + ' sequential hostnames will be generated starting with this one.</small></div>');
                                    } else {
                                        $('#multiple-hostnames-note small').text('Note: ' + hostCount + ' sequential hostnames will be generated starting with this one.');
                                    }
                                } else {
                                    $('#multiple-hostnames-note').remove();
                                }
                            } else {
                                console.error('Error checking hostnames:', data.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX error:', error);
                        }
                    });
                }
                
                $('#id_zone_type').change(updatePreview);
                updatePreview();
            {% endif %}
            
            // Handle form submission with validation
            $('#hostname-form').submit(function(e) {
                if ($(this).find('button[name="submit"]').is(':focus')) {
                    var isValid = true;
                    var errorMessages = [];
                    
                    // Basic form validation
                    $(this).find('select[required], input[required]').each(function() {
                        if (!$(this).val()) {
                            isValid = false;
                            errorMessages.push('Please complete all required fields');
                            return false; // exit the loop
                        }
                    });
                    
                    // Custom validation for radio buttons
                    var radioGroups = {};
                    $(this).find('input[type="radio"][required]').each(function() {
                        var name = $(this).attr('name');
                        radioGroups[name] = radioGroups[name] || false;
                        if ($(this).is(':checked')) {
                            radioGroups[name] = true;
                        }
                    });
                    
                    $.each(radioGroups, function(name, isChecked) {
                        if (!isChecked) {
                            isValid = false;
                            errorMessages.push('Please select an option for ' + name.replace('_', ' '));
                        }
                    });
                    
                    // Show errors or continue
                    if (!isValid) {
                        e.preventDefault();
                        
                        // Show error message
                        var errorHtml = '<div class="alert alert-danger validation-error">';
                        $.each(errorMessages, function(i, msg) {
                            errorHtml += '<p class="mb-0">' + msg + '</p>';
                        });
                        errorHtml += '</div>';
                        
                        // Remove any existing error messages and add the new one
                        $('.validation-error').remove();
                        $(this).prepend(errorHtml);
                        
                        // Scroll to the error
                        $('html, body').animate({
                            scrollTop: $('.validation-error').offset().top - 100
                        }, 200);
                    }
                }
            });
            
            // Show/hide custom cloud code input
            $('#id_cloud_code').change(function() {
                if ($(this).val() === 'custom') {
                    $('#custom_cloud_code_group').show();
                    $('#id_custom_cloud_code').prop('required', true);
                } else {
                    $('#custom_cloud_code_group').hide();
                    $('#id_custom_cloud_code').prop('required', false);
                }
            });
            
            // Initialize custom cloud code visibility
            if ($('#id_cloud_code').val() === 'custom') {
                $('#custom_cloud_code_group').show();
                $('#id_custom_cloud_code').prop('required', true);
            } else {
                $('#custom_cloud_code_group').hide();
                $('#id_custom_cloud_code').prop('required', false);
            }
            
            // Copy results to clipboard
            $('#copy-results').click(function() {
                var textToCopy = '';
                
                // Add cluster name if it exists
                if ($('#cluster-result').length) {
                    textToCopy += 'Cluster Name: ' + $('#cluster-result').text() + '\n\n';
                }
                
                // Add hostnames
                textToCopy += 'Hostnames:\n';
                $('#hostname-results li').each(function(index) {
                    textToCopy += (index + 1) + '. ' + $(this).text() + '\n';
                });
                
                // Copy to clipboard
                navigator.clipboard.writeText(textToCopy).then(function() {
                    // Change button text temporarily
                    var $btn = $('#copy-results');
                    var originalText = $btn.text();
                    $btn.text('Copied!');
                    setTimeout(function() {
                        $btn.text(originalText);
                    }, 2000);
                }, function() {
                    alert('Failed to copy to clipboard');
                });
            });
            
            // Handle showing/hiding the custom cloud code field
            function toggleCustomCloudCode() {
                if ($('#id_cloud_code').val() === 'custom') {
                    $('#custom_cloud_code_group').show();
                    $('#id_custom_cloud_code').prop('required', true);
                } else {
                    $('#custom_cloud_code_group').hide();
                    $('#id_custom_cloud_code').prop('required', false);
                }
            }
            
            // Call on page load and when the select changes
            $('#id_cloud_code').change(toggleCustomCloudCode);
            toggleCustomCloudCode();
            
            // Show custom field if custom option is selected or if a custom value is present
            {% if current_step == 8 %}
                if ($('#id_cloud_code').val() === 'custom' || 
                    ("{{ prev_data.8.cloud_code }}" !== "QQA" && 
                     "{{ prev_data.8.cloud_code }}" !== "QQB" && 
                     "{{ prev_data.8.cloud_code }}" !== "QQC" && 
                     "{{ prev_data.8.cloud_code }}")) {
                    $('#id_cloud_code').val('custom');
                    $('#custom_cloud_code_group').show();
                    $('#id_custom_cloud_code').prop('required', true);
                }
            {% endif %}
            
            // Set up hardware type and cloud code interaction
            {% if current_step == 7 %}
                $('#id_hardware_type').change(function() {
                    // Store the hardware choice in session storage for next step
                    sessionStorage.setItem('hardwareType', $(this).val());
                });
            {% endif %}

            {% if current_step == 8 %}
                // Check if we're coming from hardware type selection and adjust cloud code options
                $(function() {
                    var hardwareType = sessionStorage.getItem('hardwareType');
                    
                    // If hardware type was HP (DEF), pre-select QQC and show tg# input
                    if (hardwareType === 'HP') {
                        // Hide standard options except QQC and Custom
                        $('#id_cloud_code option[value="QQA"]').hide();
                        $('#id_cloud_code option[value="QQB"]').hide();
                        
                        // Add tg# option if not already present
                        if ($('#id_cloud_code option[value="tg"]').length === 0) {
                            $('#id_cloud_code').append('<option value="tg">TG# (Enter digit below)</option>');
                        }
                        
                        // Pre-select QQC
                        $('#id_cloud_code').val('QQC');
                        
                        // Create the tg# input field if not exists
                        if ($('#tg_number_group').length === 0) {
                            var tgInput = '<div class="form-group" id="tg_number_group">' +
                                '<label for="id_tg_number">Enter TG number (0-9):</label>' +
                                '<input type="number" name="tg_number" id="id_tg_number" class="form-control" ' +
                                'min="0" max="9" step="1" required>' +
                                '<small class="form-text text-muted">Please enter a single digit (0-9)</small>' +
                                '</div>';
                            $('#custom_cloud_code_group').after(tgInput);
                        }
                        
                        // Show/hide tg input based on selection
                        $('#id_cloud_code').change(function() {
                            if ($(this).val() === 'tg') {
                                $('#tg_number_group').show();
                                $('#custom_cloud_code_group').hide();
                                $('#id_tg_number').prop('required', true);
                                $('#id_custom_cloud_code').prop('required', false);
                            } else if ($(this).val() === 'custom') {
                                $('#tg_number_group').hide();
                                $('#custom_cloud_code_group').show();
                                $('#id_tg_number').prop('required', false);
                                $('#id_custom_cloud_code').prop('required', true);
                            } else {
                                $('#tg_number_group').hide();
                                $('#custom_cloud_code_group').hide();
                                $('#id_tg_number').prop('required', false);
                                $('#id_custom_cloud_code').prop('required', false);
                            }
                        });
                        
                        // Initial toggle
                        if ($('#id_cloud_code').val() === 'tg') {
                            $('#tg_number_group').show();
                            $('#custom_cloud_code_group').hide();
                        } else {
                            $('#tg_number_group').hide();
                        }
                    } 
                    // If hardware type was Dell (ABC) or other
                    else if (hardwareType === 'Dell') {
                        // Hide QQC option
                        $('#id_cloud_code option[value="QQC"]').hide();
                        // Show QQA and QQB
                        $('#id_cloud_code option[value="QQA"]').show();
                        $('#id_cloud_code option[value="QQB"]').show();
                        // Remove TG# option if exists
                        $('#id_cloud_code option[value="tg"]').remove();
                        // Hide TG input field if exists
                        $('#tg_number_group').hide();
                        
                        // If QQC was previously selected, change to QQA
                        if ($('#id_cloud_code').val() === 'QQC') {
                            $('#id_cloud_code').val('QQA');
                        }
                    }
                    
                    // Handle form submission to combine tg# value
                    $('form').on('submit', function() {
                        if ($('#id_cloud_code').val() === 'tg' && $('#id_tg_number').val()) {
                            var tgValue = 'tg' + $('#id_tg_number').val();
                            // Add a hidden field with the combined value
                            $(this).append('<input type="hidden" name="custom_cloud_code" value="' + tgValue + '">');
                            $('#id_cloud_code').val('custom'); // Set to custom so backend processes it correctly
                        }
                    });
                });
            {% endif %}
            
            // Add a confirm dialog for the Start Over button
            $('a.btn-warning').on('click', function(e) {
                if (!confirm('Are you sure you want to start over? All your current selections will be lost.')) {
                    e.preventDefault();
                }
            });
            
            // Add progress bar functionality
            var totalSteps = {{ steps_to_display|length }};
            var currentStep = {{ current_step }};
            var progress = Math.round((currentStep / totalSteps) * 100);
            
            if ($('.step-indicator').length > 0) {
                $('.step-indicator').after('<div class="progress mb-4"><div class="progress-bar" role="progressbar" style="width: ' 
                    + progress + '%;" aria-valuenow="' + progress 
                    + '" aria-valuemin="0" aria-valuemax="100">' + progress + '%</div></div>');
            }
        });
    </script>
    
    <!-- Additional script for next available hostname detection -->
    <script>
        $(document).ready(function() {
            // Function to validate and format hostname numbers
            function formatHostnameNumber(number, isDmz) {
                if (isDmz) {
                    // DMZ hostnames use 3 digits (001, 002, etc.)
                    return String(number).padStart(3, '0');
                } else {
                    // Regular hostnames use 4 digits (0001, 0002, etc.)
                    return String(number).padStart(4, '0');
                }
            }
            
            // Form submission additional validation
            $('#hostname-form').on('submit', function() {
                if ($(this).find('button[name="submit"]').is(':focus')) {
                    // Add a hidden field with validation data
                    $(this).append('<input type="hidden" name="validate_sequence" value="true">');
                    
                    // Store expected sequence information
                    if ({% if current_step == 9 %}true{% else %}false{% endif %}) {
                        var baseHostname = $('#hostname-preview').text().replace(/\d+$/, '');
                        $(this).append('<input type="hidden" name="base_hostname" value="' + baseHostname + '">');
                    }
                }
            });
            
            // Function to check for existing hostnames and get next sequence
            function checkExistingHostnames() {
                var zoneType = $('#id_zone_type').val();
                var datacenter = "{{ prev_data.5.datacenter|default:'' }}";
                var isDmz = "{{ prev_data.6.is_dmz|default:'False' }}";
                var hardwareType = "{{ prev_data.7.hardware_type|default:'' }}";
                var cloudCode = "{{ prev_data.8.cloud_code|default:'' }}";
                
                if (cloudCode === "custom") {
                    cloudCode = "{{ prev_data.8.custom_cloud_code }}";
                }
                
                if (!zoneType || !datacenter || !hardwareType || !cloudCode) {
                    return; // Exit if missing required data
                }
                
                // Create base hostname without number
                var baseHostname = '';
                var sitecode = '';
                
                {% for dc in datacenters %}
                    if ("{{ dc.datacenter }}" === datacenter) {
                        sitecode = "{{ dc.sitecode }}";
                    }
                {% endfor %}
                
                if (isDmz === "True") {
                    baseHostname = 'v' + sitecode.toLowerCase() + 'u111swea';
                } else {
                    var hwCode = hardwareType === "Dell" ? "d" : (hardwareType === "HP" ? "h" : "x");
                    var cloudCodeShort = cloudCode.toLowerCase().substring(0, 3);
                    var zoneTypeShort = zoneType.toLowerCase().substring(0, 3);
                    baseHostname = 'l-v' + sitecode.toLowerCase() + hwCode + cloudCodeShort + zoneTypeShort;
                }
                
                // Send AJAX request to check for existing hostnames
                $.ajax({
                    url: "{% url 'check_existing_hostnames' %}", 
                    type: "POST",
                    data: {
                        'base_hostname': baseHostname,
                        'is_dmz': isDmz,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(data) {
                        if (data.success) {
                            var nextSequence = data.next_sequence;
                            var hostCount = parseInt("{{ prev_data.4.hostname_count|default:'1' }}");
                            
                            // Show preview with next available sequence
                            if (isDmz === "True") {
                                var sequenceFormat = String(nextSequence).padStart(3, '0');
                                $('#hostname-preview').text(baseHostname + sequenceFormat);
                            } else {
                                var sequenceFormat = String(nextSequence).padStart(4, '0');
                                $('#hostname-preview').text(baseHostname + sequenceFormat);
                            }
                            
                            // Show a note about the sequence
                            if (nextSequence > 1) {
                                if ($('#sequence-note').length === 0) {
                                    $('#hostname-preview').after('<div id="sequence-note" class="text-info mt-2"><small>Note: Previous hostnames exist in this sequence. This will be the next available number.</small></div>');
                                }
                            } else {
                                $('#sequence-note').remove();
                            }
                            
                            // If multiple hostnames requested, show a note
                            if (hostCount > 1) {
                                if ($('#multiple-hostnames-note').length === 0) {
                                    $('#hostname-preview').after('<div id="multiple-hostnames-note" class="text-info mt-2"><small>Note: ' + hostCount + ' sequential hostnames will be generated starting with this one.</small></div>');
                                } else {
                                    $('#multiple-hostnames-note small').text('Note: ' + hostCount + ' sequential hostnames will be generated starting with this one.');
                                }
                            } else {
                                $('#multiple-hostnames-note').remove();
                            }
                        } else {
                            console.error('Error checking hostnames:', data.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', error);
                    }
                });
            }
            
            // Call the check function on zone type change or page load
            {% if current_step == 9 %}
                $('#id_zone_type').change(checkExistingHostnames);
                
                // Initial check when form is ready
                if ($('#id_zone_type').val()) {
                    setTimeout(checkExistingHostnames, 500);
                }
            {% endif %}
        });
    </script>
</body>
</html>